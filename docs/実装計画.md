# Firebase Authentication × LINEログイン技術検証デモサイト 実装計画

## プロジェクト概要

- **目的**: LINEログインを通じてFirebase Authenticationにユーザーをログインさせる技術構成の検証と共有
- **特に重要な点**: iOS Safariでの安定動作（LINE OAuth 2.0 APIを使用したカスタム認証フロー）
- **開発状況**: 実装完了、テスト実施済み
- **環境設定**: Firebase/LINE Developersの設定完了
- **開発環境**: Firebase Emulatorを使用
- **デプロイ**: GitHub Actionsによる自動デプロイ
- **多言語対応**: 日本語と英語のバイリンガル対応（コメントとUI）

## 実装計画

### 1. 環境構築

#### 1.1 Firebase プロジェクトの設定
- Firebase プロジェクトの作成
- Firebase Authentication の有効化
- Firebase Functions の有効化
- Firebase Hosting の有効化
- Firebase Admin SDK の設定

#### 1.2 LINE Developers の設定
- LINE Developers アカウントの作成
- LINE Login チャネルの作成
- コールバックURLの設定
- チャネルID、チャネルシークレットの取得

#### 1.3 開発環境の構築
- Firebase CLI のインストール
- Firebase Emulator の設定
- Nuxt 3 の開発環境設定

### 2. バックエンド実装（Firebase Functions）

#### 2.1 プロジェクト初期化
- package.json の作成
- tsconfig.json の設定
- .eslintrc.json の設定
- 必要なパッケージのインストール
- Firebase Admin SDK設定

#### 2.2 LINE OAuth コールバック処理の実装
- LINE OAuth 2.0 フローの処理
- アクセストークンの取得
- ユーザープロフィールの取得
- Firebase カスタムトークンの生成

#### 2.3 API エンドポイントの実装
- `/line-callback`: LINE OAuth コールバック処理（POST メソッド）
- `/auth/custom-token`: カスタムトークン生成API（POST メソッド）

#### 2.4 テストコードの実装
- 各機能のユニットテスト
- モック/スタブを使用した外部依存の分離
- 日本語と英語のエラーメッセージ対応

### 3. フロントエンド実装（Nuxt 3）

#### 3.1 プロジェクト初期化
- package.json の作成
- nuxt.config.ts の設定
- tsconfig.json の設定

#### 3.2 Firebase 初期化
- plugins/firebase.client.ts の実装
- 環境変数の設定

#### 3.3 認証状態管理の実装
- Firebase 認証状態の管理用 Composable（composables/useAuth.ts）
- LINE ログイン処理
- ログアウト処理

#### 3.4 UI 実装
- トップページ（pages/index.vue）
  - LINE ログインボタン
  - 認証状態表示
- ダッシュボードページ（pages/dashboard.vue）
  - ログイン後の画面
  - ユーザー情報表示
  - ログアウトボタン

### 4. デプロイ設定

#### 4.1 Firebase 設定
- firebase.json の設定
- .firebaserc の設定

#### 4.2 CI/CD 設定
- GitHub Actions の設定
  - コードチェック
  - ビルド
  - デプロイ

### 5. テスト

#### 5.1 ユニットテスト
- Jest を使用したテストの実行
- Firebase Functions のテスト
- LINE コールバック処理のテスト

#### 5.2 ローカルテスト
- Firebase Emulator を使用したローカルテスト
- 各機能の動作確認
- テストコマンド: `npm test`

#### 5.3 デバイステスト
- iOS Safari でのテスト
- Android でのテスト
- PC ブラウザでのテスト

### 6. ドキュメント作成
- README の作成
- 構成図の作成
- 導入手順の作成

## 技術的な実装ポイント

### LINE OAuth 2.0 APIを使用したカスタム認証フロー
1. フロントエンドでLINEログインボタンを実装
2. ユーザーがボタンをクリックするとLINE認証画面へリダイレクト
3. 認証後、コールバックURLにリダイレクト（認可コード付き）
4. フロントエンドでURLパラメータから認可コードを取得
5. 認可コードをバックエンドに送信（POST /line-callback）
6. バックエンドで認可コードを使ってアクセストークンを取得
7. アクセストークンを使ってユーザープロフィールを取得
8. ユーザー情報を基にFirebase Admin SDKでカスタムトークンを生成
9. フロントエンドにカスタムトークンを返却
10. フロントエンドでカスタムトークンを使ってFirebase Authenticationにサインイン

### iOS Safariでの問題回避策
- LINE OAuth 2.0 APIを直接使用し、state パラメータを使用して認証状態を検証
- localStorage を使用してstate値を保存し、コールバック時に検証
- バックエンドでのトークン処理により、フロントエンドでのセッション状態管理を簡素化
- コールバック処理後のリダイレクト先を適切に設定し、同一タブでの処理を保証

## 環境変数の管理方法

### 1. 環境変数の管理方針
- フロントエンドとバックエンドで別々に環境変数を管理
- 開発環境と本番環境で異なる設定を適用
- 機密情報は適切に保護

### 2. フロントエンド（Nuxt 3）の環境変数管理

#### 2.1 環境変数ファイルの構成
- `.env`: 共通の環境変数
- `.env.local`: ローカル開発環境用（Gitで管理しない）
- `.env.development`: 開発環境用
- `.env.production`: 本番環境用

#### 2.2 管理する主な環境変数
```
# Firebase設定
FIREBASE_API_KEY=xxx
FIREBASE_AUTH_DOMAIN=xxx
FIREBASE_PROJECT_ID=xxx
FIREBASE_STORAGE_BUCKET=xxx
FIREBASE_MESSAGING_SENDER_ID=xxx
FIREBASE_APP_ID=xxx

# LINE Login設定
LINE_CHANNEL_ID=xxx
LINE_CALLBACK_URL=xxx

# API設定
API_BASE_URL=xxx
```

#### 2.3 Nuxt.config.tsでの環境変数の設定
```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    // サーバーサイドでのみ利用可能な変数
    apiSecret: process.env.API_SECRET,
    
    // クライアントサイドでも利用可能な変数
    public: {
      apiBaseUrl: process.env.API_BASE_URL,
      firebase: {
        apiKey: process.env.FIREBASE_API_KEY,
        authDomain: process.env.FIREBASE_AUTH_DOMAIN,
        projectId: process.env.FIREBASE_PROJECT_ID,
        storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
        messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
        appId: process.env.FIREBASE_APP_ID,
      },
      line: {
        channelId: process.env.LINE_CHANNEL_ID,
        callbackUrl: process.env.LINE_CALLBACK_URL,
      },
    },
  },
})
```

### 3. バックエンド（Firebase Functions）の環境変数管理

#### 3.1 ローカル開発環境での環境変数管理
- `functions/.env.local`: ローカル開発用の環境変数（Gitで管理しない）
- Firebase Emulator起動時に環境変数を読み込む設定

#### 3.2 本番環境での環境変数管理
- Firebase Console上での環境変数設定
- Firebase CLIを使った環境変数の設定
```bash
firebase functions:config:set line.channel_id="xxx" line.channel_secret="xxx"
```

#### 3.3 管理する主な環境変数
```
# LINE API設定
LINE_CHANNEL_ID=xxx
LINE_CHANNEL_SECRET=xxx

# Firebase Admin設定
FIREBASE_DATABASE_URL=xxx

# セキュリティ設定
TOKEN_EXPIRES_IN=3600 # 1時間
```

#### 3.4 環境変数の読み込み方法
```typescript
// functions/src/handlers/lineCallback.ts
import * as dotenv from "dotenv";

// 環境変数の読み込み
// Load environment variables
dotenv.config({ path: ".env.local" });

// 環境変数から LINE の設定を取得
// Get LINE configuration from environment variables
const getLineConfig = () => {
  try {
    // 環境変数から直接設定を取得
    // Get configuration directly from environment variables
    const config = {
      channel_id: process.env.LINE_CHANNEL_ID,
      channel_secret: process.env.LINE_CHANNEL_SECRET,
      callback_url: process.env.LINE_CALLBACK_URL,
    };

    // 環境変数が設定されていない場合はエラーを投げる
    // Throw an error if environment variables are not set
    if (!config.channel_id || !config.channel_secret || !config.callback_url) {
      throw new Error("LINE configuration is missing");
    }

    return config;
  } catch (error) {
    console.error("Failed to get LINE configuration:", error);
    throw new Error("LINE configuration is missing");
  }
};
```

### 4. 環境切り替えの自動化

#### 4.1 開発環境と本番環境の切り替え
- `package.json`にスクリプトを追加して環境切り替えを簡素化
```json
{
  "scripts": {
    "dev": "cross-env NODE_ENV=development nuxt dev",
    "build": "cross-env NODE_ENV=production nuxt build",
    "emulate": "firebase emulators:start --import=./emulator-data --export-on-exit"
  }
}
```

#### 4.2 Firebase Emulatorの設定
- Emulator使用時に自動的に開発環境の設定を使用するように構成
```typescript
// plugins/firebase.client.ts
// 開発環境の場合は Firebase Emulator に接続
// Connect to Firebase Emulator in development environment
if (process.env.NODE_ENV !== 'production') {
  connectAuthEmulator(auth, 'http://localhost:9099');
  connectFunctionsEmulator(functions, 'localhost', 5001);
}
```

#### 4.3 テスト実行の設定
- Jest を使用したテスト実行の設定
```json
// functions/package.json
{
  "scripts": {
    "lint": "eslint --ext .js,.ts .",
    "build": "tsc",
    "build:watch": "tsc --watch",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log",
    "test": "jest"
  }
}
```

### 5. CI/CD パイプラインでの環境変数管理

#### 5.1 GitHub Secretsの活用
- 機密情報（APIキーなど）はGitHub Secretsに保存
- GitHub Actionsのワークフローで環境変数として利用

#### 5.2 GitHub Actionsワークフローでの環境変数設定
```yaml
# .github/workflows/deploy.yml
name: Deploy to Firebase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      # 環境変数の設定
      - name: Set environment variables
        run: |
          echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> $GITHUB_ENV
          echo "FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}" >> $GITHUB_ENV
          # その他の環境変数
          
      # フロントエンドのビルド
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          
      # バックエンドのデプロイ
      - name: Deploy functions
        run: |
          cd functions
          npm ci
          npm run build
          firebase deploy --only functions --token "${{ secrets.FIREBASE_TOKEN }}"
```

### 6. セキュリティ上の注意点

#### 6.1 機密情報の管理
- APIキーやシークレットなどの機密情報は`.env.local`などのGit管理外のファイルに保存
- 本番環境では Firebase Secret Manager や GitHub Secrets を活用

#### 6.2 環境変数の検証
- 必須環境変数が設定されているか起動時に検証するロジックを実装
- 環境変数の型や形式を検証するバリデーション処理の追加